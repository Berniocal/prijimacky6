<!doctype html>
<html lang="cs">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>M7A – trenažér (obrázky + geo klikání)</title>

<style>
  :root{
    --bg:#0b1220; --card:#121a2c; --ink:#e8eefc; --muted:#9fb0d6;
    --ok:#22c55e; --bad:#ef4444; --btn:#1f2a44;
    --panel:#0f1729; --stroke:rgba(255,255,255,.18);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:1200px;margin:0 auto;padding:18px}
  .card{background:var(--card);border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  h1{margin:0 0 6px;font-size:22px}
  .muted{color:var(--muted)}
  .small{font-size:13px}
  .hr{height:1px;background:rgba(255,255,255,.08);margin:14px 0}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:space-between}
  .pill{padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.06)}
  .qid{font-size:14px;color:var(--muted);margin-top:4px}
  .prompt{margin-top:10px;font-size:17px}
  .input{margin-top:14px}

  input[type="text"]{
    width:min(520px,100%);padding:12px 12px;border-radius:12px;border:1px solid var(--stroke);
    background:var(--panel);color:var(--ink);font-size:16px;outline:none
  }

  .choices{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  .choice{
    padding:10px 12px;border-radius:12px;border:1px solid var(--stroke);
    background:var(--panel);color:var(--ink);cursor:pointer;user-select:none;
    min-width:56px;text-align:center;font-weight:900
  }
  .choice.sel{outline:2px solid rgba(34,197,94,.7);border-color:rgba(34,197,94,.9)}

  .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:16px}
  button{
    border:0;border-radius:12px;padding:10px 12px;background:var(--btn);color:var(--ink);
    font-weight:900;cursor:pointer
  }
  button.primary{background:linear-gradient(135deg,#2563eb,#22c55e)}
  button.ghost{background:transparent;border:1px solid var(--stroke)}
  button:disabled{opacity:.45;cursor:not-allowed}

  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px 8px;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;vertical-align:top}
  .ok{color:var(--ok);font-weight:900}
  .bad{color:var(--bad);font-weight:900}
  .note{color:var(--muted);font-size:13px}

  /* Navigator */
  .navwrap{
    margin-top:10px;
    padding:10px;
    border:1px solid var(--stroke);
    border-radius:16px;
    background:rgba(255,255,255,.03);
  }
  .navgrid{display:flex;flex-wrap:wrap;gap:8px}
  .navbtn{
    border:1px solid var(--stroke);
    background:var(--panel);
    color:var(--ink);
    border-radius:12px;
    padding:8px 10px;
    font-weight:900;
    cursor:pointer;
    min-width:62px;
    text-align:center;
  }
  .navbtn.active{outline:2px solid rgba(59,130,246,.85)}
  .navbtn.answered{border-color:rgba(34,197,94,.8)}
  .navlegend{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
  .dot{display:inline-block;width:10px;height:10px;border-radius:999px;margin-right:6px;vertical-align:middle}
  .dotBlue{background:rgba(59,130,246,.9)}
  .dotGreen{background:rgba(34,197,94,.9)}
  .dotGray{background:rgba(255,255,255,.25)}

  /* Split layout: vlevo odpovědi, vpravo obrázek */
  .split{
    display:grid;
    grid-template-columns: 1.02fr .98fr;
    gap:14px;
    align-items:start;
    margin-top:8px;
  }
  @media (max-width: 980px){
    .split{ grid-template-columns: 1fr; }
  }

  .imgpanel{
    background:rgba(255,255,255,.03);
    border:1px solid var(--stroke);
    border-radius:16px;
    overflow:hidden;
  }
  .imghead{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    padding:10px 12px;
    background:rgba(255,255,255,.03);
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .imgtitle{font-weight:900}
  .imgwrap{
    padding:10px;
    background:#000;
  }
  .taskimg{
    width:100%;
    height:auto;
    display:block;
    border-radius:12px;
    background:#000;
    object-fit:contain;
  }
  .imgnote{
    padding:10px 12px;
    border-top:1px solid rgba(255,255,255,.08);
    color:var(--muted);
    font-size:13px;
  }

  /* Geo panel */
  .geohead{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    margin-top:12px;
    padding:10px 12px;
    border:1px solid rgba(255,255,255,.10);
    border-radius:12px;
    background:rgba(255,255,255,.03);
  }
  .geohead input{transform:scale(1.15)}
  .geobox{
    margin-top:10px;
    border:1px solid rgba(255,255,255,.10);
    border-radius:16px;
    overflow:hidden;
    background:rgba(255,255,255,.03);
  }

  /* Modal full-screen obrázek */
  .modal{
    position:fixed; inset:0;
    background:rgba(0,0,0,.78);
    display:none;
    align-items:center;
    justify-content:center;
    padding:12px;
    z-index:9999;
  }
  .modal.open{ display:flex; }
  .modalcard{
    width:min(1100px, 100%);
    height:min(92vh, 100%);
    background:#0a0f1b;
    border:1px solid rgba(255,255,255,.14);
    border-radius:16px;
    overflow:hidden;
    display:flex;
    flex-direction:column;
  }
  .modalbar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px 12px;
    background:rgba(255,255,255,.04);
    border-bottom:1px solid rgba(255,255,255,.10);
  }
  .modalbar b{ font-size:14px; }
  .modalcontent{
    flex:1;
    overflow:auto;
    background:#000;
    -webkit-overflow-scrolling: touch;
  }
  .modalimg{
    width:100%;
    height:auto;
    display:block;
    transform-origin: 0 0;
  }
  .zoombtns{display:flex;gap:8px;flex-wrap:wrap}
</style>
</head>

<body>
<div class="wrap">
  <div class="card" id="app">
    <div class="row">
      <div>
        <h1>M7A – trenažér</h1>
        <div class="muted small">
          Vpravo je obrázek zadání úlohy (1.jpg…16.jpg) ze stejné složky. Úlohy 8 a 9 jsou klikací (SVG).
        </div>
      </div>
      <div class="row" style="gap:10px">
        <div class="pill"><span id="qno">1</span>/<span id="qtotal">1</span></div>
      </div>
    </div>

    <div class="navwrap">
      <div class="muted small"><b>Přehled úloh:</b> kliknutím přejdeš na úlohu</div>
      <div class="navgrid" id="navgrid"></div>
      <div class="navlegend muted small">
        <span><span class="dot dotBlue"></span>aktuální</span>
        <span><span class="dot dotGreen"></span>zodpovězeno</span>
        <span><span class="dot dotGray"></span>nezodpovězeno</span>
      </div>
    </div>

    <div class="hr"></div>

    <div id="screen-quiz">
      <div class="split">
        <!-- LEFT: answers -->
        <div>
          <div class="row">
            <div class="muted small" id="qtype"></div>
            <div class="muted small" id="qhint"></div>
          </div>

          <div class="qid" id="qid"></div>
          <div class="prompt" id="prompt"></div>
          <div class="input" id="input-area"></div>

          <div class="btns">
            <button class="ghost" id="prevBtn">Zpět</button>
            <button class="primary" id="nextBtn">Další</button>
            <button class="ghost" id="finishBtn" style="margin-left:auto; display:none;">Vyhodnotit</button>
          </div>

          <div class="note" style="margin-top:10px">
            Tip: piš jen výsledek (např. <b>18:40</b>, <b>33</b>, <b>-1/2</b>, <b>52:49</b>).
          </div>
        </div>

        <!-- RIGHT: IMAGE -->
        <div class="imgpanel">
          <div class="imghead">
            <div class="imgtitle" id="imgTitle">Zadání (1.jpg)</div>
            <div class="zoombtns">
              <button class="ghost" type="button" id="imgReloadBtn">Obnovit</button>
              <button class="ghost" type="button" id="imgOpenBtn">Zvětšit</button>
            </div>
          </div>
          <div class="imgwrap">
            <img id="taskImg" class="taskimg" alt="Zadání úlohy" loading="eager">
          </div>
          <div class="imgnote" id="imgNote">Pokud je úloha ve spodní části, posuň obrázek níž (scroll).</div>
        </div>
      </div>
    </div>

    <div id="screen-result" style="display:none">
      <div class="row">
        <div class="pill"><b>Skóre:</b> <span id="score"></span></div>
        <div class="muted small" id="scoreDetail"></div>
      </div>
      <div class="hr"></div>

      <div class="btns">
        <button class="primary" id="copyBtn">Zkopírovat výsledky</button>
        <a id="mailtoLink" href="#" style="text-decoration:none">
          <button class="ghost" id="mailBtn">Odeslat na e-mail</button>
        </a>
      </div>

      <div id="resultTable"></div>
    </div>
  </div>
</div>

<!-- Modal for full screen image -->
<div class="modal" id="imgModal" aria-hidden="true">
  <div class="modalcard">
    <div class="modalbar">
      <b id="modalTitle">Zadání</b>
      <div class="zoombtns">
        <button class="ghost" type="button" id="zoomOut">−</button>
        <button class="ghost" type="button" id="zoomReset">100%</button>
        <button class="ghost" type="button" id="zoomIn">+</button>
        <button class="ghost" type="button" id="modalClose">Zavřít</button>
      </div>
    </div>
    <div class="modalcontent" id="modalContent">
      <img id="modalImg" class="modalimg" alt="Zadání ve velkém">
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG: obrázky ve stejné složce
========================= */
function taskImagePath(taskNo){
  // očekává 1.jpg ... 16.jpg
  return `./${taskNo}.jpg`;
}

/* =========================
   HELPERS
========================= */
const $ = sel => document.querySelector(sel);

function norm(s){
  return String(s ?? "")
    .trim()
    .toLowerCase()
    .replaceAll("\u00A0"," ")
    .replace(/\s+/g,"")
    .replaceAll(",", ".");
}
function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

/* =========================
   GEOMETRY HELPERS
========================= */
function vsub(a,b){ return {x:a.x-b.x, y:a.y-b.y}; }
function vadd(a,b){ return {x:a.x+b.x, y:a.y+b.y}; }
function vmul(a,k){ return {x:a.x*k, y:a.y*k}; }
function vdot(a,b){ return a.x*b.x + a.y*b.y; }
function vlen(a){ return Math.hypot(a.x,a.y); }
function vnorm(a){
  const L = vlen(a) || 1;
  return {x:a.x/L, y:a.y/L};
}
function vproj(u, ontoUnit){
  const t = vdot(u, ontoUnit);
  return vmul(ontoUnit, t);
}
function vperp(u, ontoUnit){
  const proj = vproj(u, ontoUnit);
  return vsub(u, proj);
}
function reflectVector(u, axisUnit){
  const up = vproj(u, axisUnit);
  const uq = vperp(u, axisUnit);
  return vsub(up, uq);
}
function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }
function intersectLineCircle(P0, d, C, r){
  const f = vsub(P0, C);
  const a = vdot(d,d);
  const b = 2*vdot(f,d);
  const c = vdot(f,f) - r*r;
  const disc = b*b - 4*a*c;
  if(disc < -1e-9) return [];
  if(Math.abs(disc) < 1e-9){
    const t = -b/(2*a);
    return [vadd(P0, vmul(d,t))];
  }
  const s = Math.sqrt(disc);
  const t1 = (-b + s)/(2*a);
  const t2 = (-b - s)/(2*a);
  return [vadd(P0, vmul(d,t1)), vadd(P0, vmul(d,t2))];
}

/* =========================
   QUESTIONS
   - task: číslo úlohy pro obrázek (1..16)
   - id: zobrazené číslo (1.1, 1.2…)
========================= */
const QUESTIONS = [
  // Úloha 1 (obrázek 1.jpg)
  { id:"1.1", task:1, type:"text", prompt:"Úloha 1 – odpověď 1.1", answer:["18:40"] },
  { id:"1.2", task:1, type:"text", prompt:"Úloha 1 – odpověď 1.2", answer:["33","33min","33minut","33 minut","33min."] },

  // Úloha 2 (obrázek 2.jpg)
  { id:"2.1", task:2, type:"text", prompt:"Úloha 2 – odpověď 2.1", answer:["-1/2","−1/2"] },
  { id:"2.2", task:2, type:"text", prompt:"Úloha 2 – odpověď 2.2", answer:["3/4"] },

  // Úloha 3 (3.jpg)
  { id:"3.1", task:3, type:"text", prompt:"Úloha 3.1", answer:["120"] },
  { id:"3.2", task:3, type:"text", prompt:"Úloha 3.2", answer:["48"] },

  // Úloha 4 (4.jpg)
  { id:"4.1", task:4, type:"text", prompt:"Úloha 4.1", answer:["600","600kč","600 Kč"] },
  { id:"4.2", task:4, type:"text", prompt:"Úloha 4.2", answer:["200","200kč","200 Kč","o200","o 200"] },
  { id:"4.3", task:4, type:"text", prompt:"Úloha 4.3", answer:["1900","1 900","1900 Kč","1 900 Kč","1900kč"] },

  // Úloha 5 (5.jpg)
  { id:"5.1", task:5, type:"text", prompt:"Úloha 5.1", answer:["21","21kč","21 Kč"] },
  { id:"5.2", task:5, type:"text", prompt:"Úloha 5.2", answer:["42","42kč","42 Kč"] },

  // Úloha 6 (6.jpg)
  { id:"6.1", task:6, type:"text", prompt:"Úloha 6.1", answer:["77"] },
  { id:"6.2", task:6, type:"text", prompt:"Úloha 6.2", answer:["3"] },
  { id:"6.3", task:6, type:"text", prompt:"Úloha 6.3", answer:["7","o7","o 7","o 7 kartiček","o7kartiček"] },

  // Úloha 7 (7.jpg)
  { id:"7.1", task:7, type:"text", prompt:"Úloha 7.1", answer:["5","5cm","5 cm"] },
  { id:"7.2", task:7, type:"text", prompt:"Úloha 7.2", answer:["110","110cm2","110 cm2","110cm²","110 cm²"] },

  // Úloha 8 (8.jpg + geo8)
  { id:"8", task:8, type:"geo8", prompt:"Úloha 8 – klikni na bod A v interaktivním nákresu", answer:["(geo)"] },

  // Úloha 9 (9.jpg + geo9)
  { id:"9", task:9, type:"geo9", prompt:"Úloha 9 – klikni na obě možné polohy bodu H", answer:["(geo)"] },

  // Úloha 10 (10.jpg)
  { id:"10.1", task:10, type:"mc2", prompt:"Úloha 10.1 – zvol A nebo N", choices:["A","N"], answer:["N"] },
  { id:"10.2", task:10, type:"mc2", prompt:"Úloha 10.2 – zvol A nebo N", choices:["A","N"], answer:["A"] },
  { id:"10.3", task:10, type:"mc2", prompt:"Úloha 10.3 – zvol A nebo N", choices:["A","N"], answer:["N"] },

  // Úloha 11–13 (11.jpg? Ne — podle tvého rozpisu jsou na jedné straně, ale ty chceš 1.jpg…16.jpg,
  // takže zde použijeme 11.jpg pro úlohu 11, 12.jpg pro 12, 13.jpg pro 13, nebo můžeš dát společný obrázek.
  // Já to nastavím 11->11.jpg, 12->12.jpg, 13->13.jpg. Pokud máš naopak společný obrázek, řekni a upravím mapu.
  { id:"11", task:11, type:"mc5", prompt:"Úloha 11 – vyber A–E", choices:["A","B","C","D","E"], answer:["B"] },
  { id:"12", task:12, type:"mc5", prompt:"Úloha 12 – vyber A–E", choices:["A","B","C","D","E"], answer:["C"] },
  { id:"13", task:13, type:"mc5", prompt:"Úloha 13 – vyber A–E", choices:["A","B","C","D","E"], answer:["A"] },

  // Úloha 14 (14.jpg)
  { id:"14", task:14, type:"mc5", prompt:"Úloha 14 – vyber A–E", choices:["A","B","C","D","E"], answer:["D"] },

  // Úloha 15 (15.jpg)
  { id:"15.1", task:15, type:"mc6", prompt:"Úloha 15.1 – vyber A–F", choices:["A","B","C","D","E","F"], answer:["A"] },
  { id:"15.2", task:15, type:"mc6", prompt:"Úloha 15.2 – vyber A–F", choices:["A","B","C","D","E","F"], answer:["E"] },
  { id:"15.3", task:15, type:"mc6", prompt:"Úloha 15.3 – vyber A–F", choices:["A","B","C","D","E","F"], answer:["F"] },

  // Úloha 16 (16.jpg)
  { id:"16.1", task:16, type:"text", prompt:"Úloha 16.1", answer:["38","38."] },
  { id:"16.2", task:16, type:"text", prompt:"Úloha 16.2", answer:["23"] },
  { id:"16.3", task:16, type:"text", prompt:"Úloha 16.3 – zapiš poměr, např. 52:49", answer:["52:49","52 : 49","52∶49"] }
];

/* =========================
   STATE
========================= */
let idx = 0;
const user = {}; // text/mc: user[id]=string; geo: user["8"]={...}, user["9"]={...}
let finished = false;
$("#qtotal").textContent = QUESTIONS.length;

/* =========================
   ANSWERED?
========================= */
function isAnswered(q){
  if(q.type==="text" || q.type==="mc2" || q.type==="mc5" || q.type==="mc6"){
    return !!(String(user[q.id] ?? "").trim());
  }
  if(q.type==="geo8"){
    return user["8"]?.ax != null;
  }
  if(q.type==="geo9"){
    return (user["9"]?.clicks?.length ?? 0) >= 2;
  }
  return false;
}

/* =========================
   NAV
========================= */
function renderNav(){
  const nav = $("#navgrid");
  nav.innerHTML = "";
  QUESTIONS.forEach((q, i) => {
    const b = document.createElement("button");
    b.className = "navbtn";
    b.textContent = q.id;
    if(i === idx) b.classList.add("active");
    if(isAnswered(q)) b.classList.add("answered");
    b.title = `Úloha ${q.id}`;
    b.addEventListener("click", () => { if(!finished){ idx = i; render(); } });
    nav.appendChild(b);
  });
}

/* =========================
   IMAGE PANEL
========================= */
function setImageForQuestion(q){
  const src = taskImagePath(q.task);
  $("#imgTitle").textContent = `Zadání (${q.task}.jpg)`;
  const img = $("#taskImg");

  img.onerror = () => {
    img.style.opacity = "1";
    img.alt = `Chybí soubor ${q.task}.jpg ve stejné složce jako index.html`;
  };

  // cache-buster při "Obnovit"
  img.dataset.base = src;
  img.src = src;

  $("#imgOpenBtn").onclick = () => openModal(src, `Zadání – úloha ${q.task}`);
  $("#imgReloadBtn").onclick = () => {
    img.src = `${src}?v=${Date.now()}`;
  };

  // hint text
  $("#imgNote").textContent =
    (q.task===2 || q.task===4 || q.task===6) ? "Tahle úloha byla v papíru ve spodní části stránky – tady jen posuň obrázek níž (scroll)." :
    "Pokud něco není vidět, posuň obrázek (scroll) nebo klikni na Zvětšit.";
}

/* =========================
   MODAL ZOOM
========================= */
let zoom = 1;

function openModal(src, title){
  $("#modalTitle").textContent = title;
  const m = $("#imgModal");
  const mi = $("#modalImg");
  zoom = 1;
  mi.style.transform = `scale(${zoom})`;
  mi.src = src;
  m.classList.add("open");
  m.setAttribute("aria-hidden","false");

  // scroll top
  $("#modalContent").scrollTop = 0;
  $("#modalContent").scrollLeft = 0;
}

function closeModal(){
  const m = $("#imgModal");
  m.classList.remove("open");
  m.setAttribute("aria-hidden","true");
}

$("#modalClose").addEventListener("click", closeModal);
$("#imgModal").addEventListener("click", (e)=>{
  if(e.target.id === "imgModal") closeModal();
});
document.addEventListener("keydown",(e)=>{
  if(e.key === "Escape") closeModal();
});
$("#zoomIn").addEventListener("click", ()=>{
  zoom = Math.min(3.5, zoom + 0.25);
  $("#modalImg").style.transform = `scale(${zoom})`;
});
$("#zoomOut").addEventListener("click", ()=>{
  zoom = Math.max(1, zoom - 0.25);
  $("#modalImg").style.transform = `scale(${zoom})`;
});
$("#zoomReset").addEventListener("click", ()=>{
  zoom = 1;
  $("#modalImg").style.transform = `scale(${zoom})`;
});

/* =========================
   GEO RENDERERS
========================= */
function renderGeo8(container){
  const B = {x:140, y:80};
  const C = {x:160, y:220};
  const O = {x:340, y:220};

  const dBC = vnorm(vsub(C,B));
  const axis = vnorm(vsub(O,B));
  const d2 = vnorm(reflectVector(dBC, axis));
  const r = dist(O,B);

  const inter = intersectLineCircle(B, d2, O, r)
    .map(p => ({p, t: vdot(vsub(p,B), d2)}))
    .filter(x => x.t > 1e-6)
    .sort((a,b)=>a.t-b.t);

  const A = inter.length ? inter[0].p : {x:0,y:0};

  const state = user["8"] || {ax:null, ay:null, showHelp:false, _tol:12, _correctA:A};
  state._correctA = A;
  user["8"] = state;

  const far = 900;
  const pBC2 = vadd(B, vmul(dBC, far));
  const pBO2 = vadd(B, vmul(axis, far));
  const pD2  = vadd(B, vmul(d2, far));

  function drawPoint(label, P){
    return `
      <g>
        <line x1="${P.x-6}" y1="${P.y-6}" x2="${P.x+6}" y2="${P.y+6}" stroke="rgba(255,255,255,.85)" stroke-width="2"/>
        <line x1="${P.x-6}" y1="${P.y+6}" x2="${P.x+6}" y2="${P.y-6}" stroke="rgba(255,255,255,.85)" stroke-width="2"/>
        <text x="${P.x+10}" y="${P.y-10}" font-size="16" fill="rgba(255,255,255,.9)">${label}</text>
      </g>
    `;
  }

  container.innerHTML = `
    <div class="geohead">
      <div style="flex:1">
        <b>Interaktivní nákres</b><br>
        <span class="muted small">Klikni na bod <b>A</b>. (Pomocné čáry lze zapnout.)</span>
      </div>
      <label class="muted small" style="display:flex;gap:10px;align-items:center;cursor:pointer">
        <input type="checkbox" id="geo8_help" ${state.showHelp ? "checked":""}>
        Pomocné čáry
      </label>
      <button class="ghost" type="button" id="geo8_clear">Smazat klik</button>
    </div>

    <div class="geobox">
      <svg id="geo8_svg" width="100%" viewBox="0 0 520 320" style="display:block; cursor:crosshair">
        <defs>
          <pattern id="grid8" width="20" height="20" patternUnits="userSpaceOnUse">
            <path d="M20 0H0V20" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="1"/>
          </pattern>
        </defs>
        <rect x="0" y="0" width="520" height="320" fill="url(#grid8)"/>

        <line x1="${B.x}" y1="${B.y}" x2="${pBC2.x}" y2="${pBC2.y}" stroke="rgba(255,255,255,.55)" stroke-width="3" />
        <line x1="${B.x}" y1="${B.y}" x2="${pBO2.x}" y2="${pBO2.y}" stroke="rgba(255,255,255,.35)" stroke-width="3" stroke-dasharray="8 8"/>

        <g id="geo8_helpers" style="display:${state.showHelp ? "block":"none"}">
          <circle cx="${O.x}" cy="${O.y}" r="${r}" fill="none" stroke="rgba(34,197,94,.45)" stroke-width="3"/>
          <line x1="${B.x}" y1="${B.y}" x2="${pD2.x}" y2="${pD2.y}" stroke="rgba(34,197,94,.55)" stroke-width="3" />
        </g>

        ${drawPoint("B", B)}
        ${drawPoint("C", C)}
        ${drawPoint("O", O)}

        <circle id="geo8_marker" r="7" fill="rgba(59,130,246,.95)" stroke="white" stroke-width="2"
                ${state.ax==null ? 'display="none"' : ''} cx="${state.ax ?? 0}" cy="${state.ay ?? 0}"></circle>
      </svg>
    </div>
  `;

  const svg = container.querySelector("#geo8_svg");
  svg.addEventListener("click", (evt)=>{
    const pt = svg.createSVGPoint();
    pt.x = evt.clientX; pt.y = evt.clientY;
    const sp = pt.matrixTransform(svg.getScreenCTM().inverse());
    state.ax = sp.x; state.ay = sp.y;
    const mk = container.querySelector("#geo8_marker");
    mk.setAttribute("display","block");
    mk.setAttribute("cx", state.ax);
    mk.setAttribute("cy", state.ay);
    renderNav();
  });

  container.querySelector("#geo8_help").addEventListener("change",(e)=>{
    state.showHelp = e.target.checked;
    container.querySelector("#geo8_helpers").style.display = state.showHelp ? "block":"none";
  });

  container.querySelector("#geo8_clear").addEventListener("click", ()=>{
    state.ax = null; state.ay = null;
    render();
  });
}

function renderGeo9(container){
  const E = {x:170, y:260};
  const F = {x:390, y:200};
  const G = {x:380, y:90};

  const state = user["9"] || {clicks:[], showHelp:false, _tol:12};
  user["9"] = state;

  const dEF = vnorm(vsub(F,E));
  const r = dist(F,G);
  const Hs = intersectLineCircle(G, dEF, E, r);
  state._correctHs = Hs;

  function drawX(label, P){
    return `
      <g>
        <line x1="${P.x-6}" y1="${P.y-6}" x2="${P.x+6}" y2="${P.y+6}" stroke="rgba(255,255,255,.85)" stroke-width="2"/>
        <line x1="${P.x-6}" y1="${P.y+6}" x2="${P.x+6}" y2="${P.y-6}" stroke="rgba(255,255,255,.85)" stroke-width="2"/>
        <text x="${P.x+10}" y="${P.y-10}" font-size="16" fill="rgba(255,255,255,.9)">${label}</text>
      </g>
    `;
  }

  const p1 = vadd(G, vmul(dEF, -900));
  const p2 = vadd(G, vmul(dEF,  900));

  container.innerHTML = `
    <div class="geohead">
      <div style="flex:1">
        <b>Interaktivní nákres</b><br>
        <span class="muted small">Klikni na <b>obě</b> možné polohy bodu <b>H</b>. (Max. 2 kliky; třetí klik začne znovu.)</span>
      </div>
      <label class="muted small" style="display:flex;gap:10px;align-items:center;cursor:pointer">
        <input type="checkbox" id="geo9_help" ${state.showHelp ? "checked":""}>
        Pomocné čáry
      </label>
      <button class="ghost" type="button" id="geo9_clear">Smazat kliky</button>
    </div>

    <div class="geobox">
      <svg id="geo9_svg" width="100%" viewBox="0 0 520 320" style="display:block; cursor:crosshair">
        <defs>
          <pattern id="grid9" width="20" height="20" patternUnits="userSpaceOnUse">
            <path d="M20 0H0V20" fill="none" stroke="rgba(255,255,255,.06)" stroke-width="1"/>
          </pattern>
        </defs>
        <rect x="0" y="0" width="520" height="320" fill="url(#grid9)"/>

        <g id="geo9_helpers" style="display:${state.showHelp ? "block":"none"}">
          <circle cx="${E.x}" cy="${E.y}" r="${r}" fill="none" stroke="rgba(34,197,94,.45)" stroke-width="3"/>
          <line x1="${p1.x}" y1="${p1.y}" x2="${p2.x}" y2="${p2.y}" stroke="rgba(34,197,94,.55)" stroke-width="3"/>
        </g>

        ${drawX("E",E)}
        ${drawX("F",F)}
        ${drawX("G",G)}

        <g id="geo9_marks"></g>
      </svg>
    </div>
  `;

  const svg = container.querySelector("#geo9_svg");
  const marks = container.querySelector("#geo9_marks");

  function redrawMarks(){
    marks.innerHTML = state.clicks.map((p, i) => `
      <g>
        <circle cx="${p.x}" cy="${p.y}" r="7" fill="rgba(59,130,246,.95)" stroke="white" stroke-width="2"></circle>
        <text x="${p.x+10}" y="${p.y+5}" font-size="14" fill="rgba(255,255,255,.9)">H${i+1}</text>
      </g>
    `).join("");
  }

  svg.addEventListener("click",(evt)=>{
    const pt = svg.createSVGPoint();
    pt.x = evt.clientX; pt.y = evt.clientY;
    const sp = pt.matrixTransform(svg.getScreenCTM().inverse());

    if(state.clicks.length < 2) state.clicks.push({x:sp.x, y:sp.y});
    else state.clicks = [{x:sp.x, y:sp.y}];

    redrawMarks();
    renderNav();
  });

  container.querySelector("#geo9_clear").addEventListener("click", ()=>{
    state.clicks = [];
    redrawMarks();
    renderNav();
  });

  container.querySelector("#geo9_help").addEventListener("change",(e)=>{
    state.showHelp = e.target.checked;
    container.querySelector("#geo9_helpers").style.display = state.showHelp ? "block":"none";
  });

  redrawMarks();
}

/* =========================
   CHECKING
========================= */
function isCorrect(q){
  if(q.type === "text" || q.type === "mc2" || q.type === "mc5" || q.type === "mc6"){
    const v = norm(user[q.id] ?? "");
    return q.answer.some(a => norm(a) === v);
  }

  if(q.type === "geo8"){
    const st = user["8"];
    if(!st || st.ax==null) return false;
    return dist({x:st.ax,y:st.ay}, st._correctA) <= (st._tol || 12);
  }

  if(q.type === "geo9"){
    const st = user["9"];
    if(!st || (st.clicks?.length ?? 0) < 2) return false;
    const Hs = st._correctHs || [];
    if(Hs.length < 2) return false;
    const tol = st._tol || 12;
    const c1 = st.clicks[0], c2 = st.clicks[1];
    const H1 = Hs[0], H2 = Hs[1];
    const okA = (dist(c1,H1)<=tol && dist(c2,H2)<=tol);
    const okB = (dist(c1,H2)<=tol && dist(c2,H1)<=tol);
    return okA || okB;
  }

  return false;
}

/* =========================
   RENDER
========================= */
function render(){
  if(finished) return;

  const q = QUESTIONS[idx];
  $("#qno").textContent = (idx+1);
  $("#qid").textContent = `Úloha ${q.id}`;
  $("#prompt").textContent = q.prompt;

  $("#qtype").textContent =
    q.type==="text" ? "otevřená odpověď" :
    q.type==="mc2" ? "A / N" :
    q.type==="mc5" ? "výběr A–E" :
    q.type==="mc6" ? "výběr A–F" :
    (q.type==="geo8" || q.type==="geo9") ? "geometrie (klikáním)" : "";

  $("#qhint").textContent =
    (q.task===2 || q.task===4 || q.task===6) ? "Pozor: v originálu to bylo ve spodní části – tady jen scrolluj obrázek." : "";

  setImageForQuestion(q);

  const area = $("#input-area");
  area.innerHTML = "";

  if(q.type === "text"){
    const inp = document.createElement("input");
    inp.type = "text";
    inp.placeholder = "Napiš odpověď…";
    inp.value = user[q.id] ?? "";
    inp.addEventListener("input", e => { user[q.id] = e.target.value; renderNav(); });
    area.appendChild(inp);
  }

  if(q.type === "mc2" || q.type === "mc5" || q.type === "mc6"){
    const wrap = document.createElement("div");
    wrap.className = "choices";
    const cur = user[q.id] ?? "";
    q.choices.forEach(ch => {
      const b = document.createElement("div");
      b.className = "choice" + (cur===ch ? " sel":"");
      b.textContent = ch;
      b.addEventListener("click", () => { user[q.id]=ch; render(); });
      wrap.appendChild(b);
    });
    area.appendChild(wrap);
  }

  if(q.type === "geo8") renderGeo8(area);
  if(q.type === "geo9") renderGeo9(area);

  $("#prevBtn").disabled = (idx===0);
  $("#nextBtn").disabled = (idx===QUESTIONS.length-1);
  $("#finishBtn").style.display = (idx===QUESTIONS.length-1) ? "inline-block" : "none";

  renderNav();
}

/* =========================
   RESULTS + COPY + MAILTO
========================= */
function buildResults(){
  let correct = 0;
  const rows = QUESTIONS.map(q => {
    const ok = isCorrect(q);
    if(ok) correct++;

    let your = "—";
    if(q.type==="text" || q.type==="mc2" || q.type==="mc5" || q.type==="mc6"){
      your = (user[q.id] ?? "") || "—";
    } else if(q.type==="geo8"){
      your = (user["8"]?.ax==null) ? "—" : "klik";
    } else if(q.type==="geo9"){
      your = (user["9"]?.clicks?.length ?? 0) >= 2 ? "2 kliky" : "—";
    }

    let corr = q.answer?.[0] ?? "";
    if(q.type==="geo8") corr = "klik na bod A";
    if(q.type==="geo9") corr = "2 polohy H";

    return { id:q.id, your, corr, ok };
  });

  return { correct, total: QUESTIONS.length, rows };
}

function resultsText(pack){
  const lines = [];
  const now = new Date();
  lines.push(`M7A – výsledky (trenažér s obrázky + geo klikání)`);
  lines.push(`Datum: ${now.toLocaleString('cs-CZ')}`);
  lines.push(`Skóre: ${pack.correct} / ${pack.total}`);
  lines.push(``);
  lines.push(`Detail:`);
  pack.rows.forEach(r=>{
    lines.push(`- ${r.id}: ${r.ok ? "OK" : "X"} | odpověď: ${r.your} | správně: ${r.corr}`);
  });
  return lines.join("\n");
}

function showResults(){
  const pack = buildResults();
  finished = true;

  $("#screen-quiz").style.display = "none";
  $("#screen-result").style.display = "block";

  $("#score").textContent = `${pack.correct} / ${pack.total}`;
  $("#scoreDetail").textContent = `Správně: ${pack.correct}, špatně/bez odpovědi: ${pack.total-pack.correct}`;

  const html = `
    <table>
      <thead>
        <tr><th>Úloha</th><th>Odpověď</th><th>Správně</th><th>Stav</th></tr>
      </thead>
      <tbody>
        ${pack.rows.map(r => `
          <tr>
            <td><b>${r.id}</b></td>
            <td>${escapeHtml(r.your)}</td>
            <td>${escapeHtml(r.corr)}</td>
            <td>${r.ok ? '<span class="ok">OK</span>' : '<span class="bad">X</span>'}</td>
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;
  $("#resultTable").innerHTML = html;

  const body = resultsText(pack);
  const subject = `M7A výsledky – ${pack.correct}/${pack.total}`;
  $("#mailtoLink").href = `mailto:jan.bernard@gyby.cz?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

  $("#copyBtn").onclick = async () => {
    try{
      await navigator.clipboard.writeText(body);
      $("#copyBtn").textContent = "Zkopírováno ✅";
      setTimeout(()=> $("#copyBtn").textContent = "Zkopírovat výsledky", 1400);
    } catch(e){
      window.prompt("Nepovedlo se zkopírovat automaticky. Zkopíruj ručně:", body);
    }
  };
}

/* =========================
   BUTTONS
========================= */
$("#prevBtn").addEventListener("click", ()=>{ if(idx>0){ idx--; render(); } });
$("#nextBtn").addEventListener("click", ()=>{ if(idx<QUESTIONS.length-1){ idx++; render(); } });
$("#finishBtn").addEventListener("click", showResults);

/* init */
render();
</script>
</body>
</html>
